<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLDP Network Topology Analysis</title>
    <link rel="shortcut icon" href="/png/favicon.ico">
    <link rel="stylesheet" type="text/css" href="/css/styles2.css">
    <style>
        .summary-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 15px; 
            margin: 20px 0; 
        }
        .summary-card { 
            background: #f8f9fa; 
            padding: 15px; 
            border-radius: 8px; 
            border-left: 4px solid #007bff; 
        }
        .card-excellent { border-left-color: #4caf50; }
        .card-good { border-left-color: #8bc34a; }
        .card-warning { border-left-color: #ff9800; }
        .card-critical { border-left-color: #f44336; }
        .card-total { border-left-color: #2196f3; }
        .card-info { border-left-color: #2196f3; }
        .card-value { font-size: 24px; font-weight: bold; color: #333; }
        
        /* Colored card values */
        .card-excellent .card-value { color: #4caf50; }
        .card-good .card-value { color: #8bc34a; }
        .card-warning .card-value { color: #ff9800; }
        .card-critical .card-value { color: #f44336; }
        .card-total .card-value { color: #333; }
        .card-info .card-value { color: #2196f3; }
        .card-label { font-size: 14px; color: #666; margin-top: 5px; }
        
        .summary-card {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .summary-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .summary-card.active {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.25);
            border-left-width: 6px;
        }
        
        .filter-info {
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            background: #e8f4fd;
            border-radius: 4px;
            color: #1976d2;
            display: none;
        }
        
        .status-success { color: #4caf50; font-weight: bold; }
        .status-fail { color: #f44336; font-weight: bold; }
        .status-warning { color: #ff9800; font-weight: bold; }
        .status-no-info { color: #f44336; font-weight: bold; }
        
        .lldp-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        .lldp-table th, .lldp-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .lldp-table th { background-color: #f2f2f2; }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .error {
            text-align: center;
            padding: 40px;
            color: #f44336;
            background: #ffeaea;
            border-radius: 8px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <h1></h1>
    <h1><font color="#b57614">LLDP Network Topology Analysis</font></h1>
    <p><strong>Last Updated:</strong> <span id="last-updated"></span></p>
    
    <h2>LLDP Connection Summary</h2>
    <div class="summary-grid">
        <div class="summary-card card-total">
            <div class="card-value" id="total-connections">0</div>
            <div class="card-label">Total Connections</div>
        </div>
        <div class="summary-card card-excellent">
            <div class="card-value" id="success-connections">0</div>
            <div class="card-label">Successful Links</div>
        </div>
        <div class="summary-card card-critical">
            <div class="card-value" id="failed-connections">0</div>
            <div class="card-label">Failed Links</div>
        </div>
        <div class="summary-card card-warning">
            <div class="card-value" id="warning-connections">0</div>
            <div class="card-label">Warning Links</div>
        </div>
        <div class="summary-card card-info">
            <div class="card-value" id="no-info-connections">0</div>
            <div class="card-label">No Information</div>
        </div>
    </div>
    
    <h2>LLDP Connection Status</h2>
    <div id="filter-info" class="filter-info">
        <span id="filter-text"></span>
        <button onclick="clearFilter()" style="margin-left: 10px; padding: 2px 8px; background: #1976d2; color: white; border: none; border-radius: 3px; cursor: pointer;">Show All</button>
    </div>
    <div id="loading" class="loading">
        <p>Loading LLDP topology data...</p>
    </div>
    <div id="error" class="error" style="display: none;">
        <p>Error loading LLDP data. Please check if the data file exists.</p>
    </div>
    <table class="lldp-table" id="lldp-table" style="display: none;">
        <tr>
            <th>Local Device</th>
            <th>Local Port</th>
            <th>Remote Device</th>
            <th>Remote Port</th>
            <th>Status</th>
            <th>Connection Health</th>
        </tr>
        <tbody id="lldp-data">
        </tbody>
    </table>



    <script>
        let totalConnections = 0;
        let successConnections = 0;
        let failedConnections = 0;
        let warningConnections = 0;
        let noInfoConnections = 0;
        
        // Filter state
        let currentFilter = 'ALL';
        let allConnections = [];

        function updateSummaryCards() {
            document.getElementById('total-connections').textContent = totalConnections;
            document.getElementById('success-connections').textContent = successConnections;
            document.getElementById('failed-connections').textContent = failedConnections;
            document.getElementById('warning-connections').textContent = warningConnections;
            document.getElementById('no-info-connections').textContent = noInfoConnections;
        }
        
        function filterConnections(filterType) {
            if (allConnections.length === 0) return;
            
            currentFilter = filterType;
            
            // Clear active state from all cards
            document.querySelectorAll('.summary-card').forEach(card => {
                card.classList.remove('active');
            });
            
            let filteredConnections = allConnections;
            let filterText = '';
            
            if (filterType === 'SUCCESS') {
                filteredConnections = allConnections.filter(conn => determineLLDPStatus(conn).status === 'SUCCESS');
                filterText = `Showing ${filteredConnections.length} Successful Links`;
                document.getElementById('success-connections').parentElement.classList.add('active');
            } else if (filterType === 'FAILED') {
                filteredConnections = allConnections.filter(conn => determineLLDPStatus(conn).status === 'FAILED');
                filterText = `Showing ${filteredConnections.length} Failed Links`;
                document.getElementById('failed-connections').parentElement.classList.add('active');
            } else if (filterType === 'WARNING') {
                filteredConnections = allConnections.filter(conn => determineLLDPStatus(conn).status === 'WARNING');
                filterText = `Showing ${filteredConnections.length} Warning Links`;
                document.getElementById('warning-connections').parentElement.classList.add('active');
            } else if (filterType === 'NO_INFO') {
                filteredConnections = allConnections.filter(conn => determineLLDPStatus(conn).status === 'NO INFO');
                filterText = `Showing ${filteredConnections.length} No Information Links`;
                document.getElementById('no-info-connections').parentElement.classList.add('active');
            } else if (filterType === 'TOTAL') {
                filteredConnections = allConnections;
                filterText = `Showing All ${filteredConnections.length} Connections`;
                document.getElementById('total-connections').parentElement.classList.add('active');
            }
            
            // Show filter info for all filters except TOTAL
            if (filterType !== 'ALL' && filterType !== 'TOTAL') {
                document.getElementById('filter-info').style.display = 'block';
                document.getElementById('filter-text').textContent = filterText;
            } else {
                document.getElementById('filter-info').style.display = 'none';
            }
            
            renderConnectionsTable(filteredConnections);
        }
        
        function clearFilter() {
            currentFilter = 'ALL';
            document.querySelectorAll('.summary-card').forEach(card => {
                card.classList.remove('active');
            });
            document.getElementById('filter-info').style.display = 'none';
            renderConnectionsTable(allConnections);
        }

        function determineLLDPStatus(connection) {
            const { lldpStatus, expectedDevice, expectedPort, actualDevice, actualPort } = connection;
            
            // Based on actual LLDP status from the data
            if (lldpStatus === 'Pass') {
                return {
                    status: 'SUCCESS',
                    healthClass: 'lldp-excellent',
                    statusClass: 'status-success',
                    health: 'LLDP Connection Verified'
                };
            } else if (lldpStatus === 'No-Info') {
                return {
                    status: 'NO INFO',
                    healthClass: 'lldp-unknown',
                    statusClass: 'status-no-info',
                    health: 'No LLDP Response Received'
                };
            } else if (lldpStatus === 'Fail') {
                // Check if it's a port mismatch
                if (actualDevice && expectedDevice && actualDevice === expectedDevice && 
                    actualPort && expectedPort && actualPort !== expectedPort) {
                    return {
                        status: 'WARNING',
                        healthClass: 'lldp-warning',
                        statusClass: 'status-warning',
                        health: `Port Mismatch: Expected ${expectedPort}, Got ${actualPort}`
                    };
                } else {
                    return {
                        status: 'FAILED',
                        healthClass: 'lldp-critical',
                        statusClass: 'status-fail',
                        health: 'Wrong Device/Port Connection'
                    };
                }
            } else {
                // Unknown status - treat as warning
                return {
                    status: 'WARNING',
                    healthClass: 'lldp-warning',
                    statusClass: 'status-warning',
                    health: `Unknown Status: ${lldpStatus}`
                };
            }
        }
        
        function renderConnectionsTable(connections) {
            const tbody = document.getElementById('lldp-data');
            tbody.innerHTML = '';
            
            connections.forEach(connection => {
                const status = determineLLDPStatus(connection);
                const row = tbody.insertRow();
                row.className = status.healthClass;
                
                row.insertCell(0).textContent = connection.localDevice;
                row.insertCell(1).textContent = connection.localPort;
                row.insertCell(2).textContent = connection.actualDevice || 'N/A';
                row.insertCell(3).textContent = connection.actualPort || 'N/A';
                
                const statusCell = row.insertCell(4);
                statusCell.innerHTML = `<span class="${status.statusClass}">${status.status}</span>`;
                
                row.insertCell(5).textContent = status.health;
            });
        }

        function parseAndDisplayLLDPData(data) {
            const tbody = document.getElementById('lldp-data');
            tbody.innerHTML = '';
            
            const lines = data.split('\n');
            const connections = [];
            let currentDevice = '';
            
            console.log('Total lines to process:', lines.length);
            
            // Parse LLDP data based on actual format
            lines.forEach((line, index) => {
                line = line.trim();
                
                // Extract device name from header lines
                if (line.includes('===') && line.length > 20) {
                    const deviceMatch = line.match(/=+\s*(.+?)\s*=+/);
                    if (deviceMatch) {
                        currentDevice = deviceMatch[1].trim();
                        console.log('Found device:', currentDevice);
                    }
                    return;
                }
                
                // Skip header and separator lines
                if (!line || line.startsWith('Port') || line.startsWith('-') || 
                    line.startsWith('Created') || line.includes('===')) {
                    return;
                }
                
                // Parse port data lines
                const parts = line.split(/\s+/);
                if (parts.length >= 6 && currentDevice) {
                    const localPort = parts[0];
                    const status = parts[1];
                    const expectedDevice = parts[2];
                    const expectedPort = parts[3];
                    const actualDevice = parts[4] === 'None' ? null : parts[4];
                    const actualPort = parts[5] === 'None' ? null : parts[5];
                    
                    connections.push({
                        localDevice: currentDevice,
                        localPort: localPort,
                        expectedDevice: expectedDevice,
                        expectedPort: expectedPort,
                        actualDevice: actualDevice,
                        actualPort: actualPort,
                        lldpStatus: status,
                        originalLine: line
                    });
                } else if (parts.length >= 6) {
                    console.log('Skipping line (no current device):', line);
                } else if (currentDevice && parts.length > 0) {
                    console.log('Skipping line (not enough parts):', line, 'Parts:', parts.length);
                }
            });
            
            console.log('Total connections parsed:', connections.length);

            // Sort connections - problems first
            connections.sort((a, b) => {
                const statusA = determineLLDPStatus(a);
                const statusB = determineLLDPStatus(b);
                
                const priority = { 'FAILED': 0, 'NO INFO': 1, 'WARNING': 2, 'SUCCESS': 3 };
                return priority[statusA.status] - priority[statusB.status];
            });

            // Store all connections for filtering
            allConnections = connections;

            // Count by status
            totalConnections = 0;
            successConnections = 0;
            failedConnections = 0;
            warningConnections = 0;
            noInfoConnections = 0;
            
            connections.forEach(connection => {
                const status = determineLLDPStatus(connection);
                totalConnections++;
                if (status.status === 'SUCCESS') successConnections++;
                else if (status.status === 'FAILED') failedConnections++;
                else if (status.status === 'WARNING') warningConnections++;
                else if (status.status === 'NO INFO') noInfoConnections++;
            });

            updateSummaryCards();
            
            // Setup click events for summary cards
            setupSummaryCardEvents();
            
            // Render table with all connections initially
            renderConnectionsTable(connections);
        }

        function showFallbackContent() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('lldp-table').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            
            // Reset summary cards to 0 when no data available
            totalConnections = 0;
            successConnections = 0;
            failedConnections = 0;
            warningConnections = 0;
            noInfoConnections = 0;
            updateSummaryCards();
            setLastUpdated();
        }
        
        function setLastUpdated() {
            const now = new Date();
            const options = { 
                year: 'numeric', 
                month: '2-digit', 
                day: '2-digit', 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit',
                hour12: true
            };
            const formattedDate = now.toLocaleString('en-US', options);
            document.getElementById('last-updated').textContent = formattedDate;
        }
        
        function setupSummaryCardEvents() {
            // Total connections card
            document.getElementById('total-connections').parentElement.addEventListener('click', function() {
                if (totalConnections > 0) filterConnections('TOTAL');
            });
            
            // Success connections card
            document.getElementById('success-connections').parentElement.addEventListener('click', function() {
                if (successConnections > 0) filterConnections('SUCCESS');
            });
            
            // Failed connections card
            document.getElementById('failed-connections').parentElement.addEventListener('click', function() {
                if (failedConnections > 0) filterConnections('FAILED');
            });
            
            // Warning connections card
            document.getElementById('warning-connections').parentElement.addEventListener('click', function() {
                if (warningConnections > 0) filterConnections('WARNING');
            });
            
            // No info connections card
            document.getElementById('no-info-connections').parentElement.addEventListener('click', function() {
                if (noInfoConnections > 0) filterConnections('NO_INFO');
            });
        }

        function loadLLDPData() {
            fetch('lldp_results.ini')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Data file not found. Status: ${response.status}`);
                    }
                    return response.text();
                })
                .then(data => {
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('lldp-table').style.display = 'table';
                    setLastUpdated();
                    parseAndDisplayLLDPData(data);
                })
                .catch(error => {
                    showFallbackContent();
                });
        }

        // Load data when page loads
        window.addEventListener('load', function() {
            setLastUpdated();
            loadLLDPData();
        });
    </script>
</body>
</html>
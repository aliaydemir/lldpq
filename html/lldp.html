<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLDP Network Topology Analysis</title>
    <link rel="shortcut icon" href="/png/favicon.ico">
    <link rel="stylesheet" type="text/css" href="/css/styles2.css">
    <style>
        .summary-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 15px; 
            margin: 20px 0; 
        }
        .summary-card { 
            background: #f8f9fa; 
            padding: 15px; 
            border-radius: 8px; 
            border-left: 4px solid #007bff; 
        }
        .card-excellent { border-left-color: #4caf50; }
        .card-good { border-left-color: #8bc34a; }
        .card-warning { border-left-color: #ff9800; }
        .card-critical { border-left-color: #f44336; }
        .card-total { border-left-color: #2196f3; }
        .card-info { border-left-color: #2196f3; }
        .card-value { font-size: 24px; font-weight: bold; color: #333; }
        
        /* Colored card values */
        .card-excellent .card-value { color: #4caf50; }
        .card-good .card-value { color: #8bc34a; }
        .card-warning .card-value { color: #ff9800; }
        .card-critical .card-value { color: #f44336; }
        .card-total .card-value { color: #333; }
        .card-info .card-value { color: #2196f3; }
        .card-label { font-size: 14px; color: #666; margin-top: 5px; }
        
        .summary-card {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .summary-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .summary-card.active {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.25);
            border-left-width: 6px;
        }
        
        .filter-info {
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            background: #e8f4fd;
            border-radius: 4px;
            color: #1976d2;
            display: none;
        }
        
        .status-success { color: #4caf50; font-weight: bold; }
        .status-fail { color: #f44336; font-weight: bold; }
        .status-warning { color: #ff9800; font-weight: bold; }
        .status-no-info { color: #f44336; font-weight: bold; }
        
        .lldp-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        .lldp-table th, .lldp-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .lldp-table th { background-color: #f2f2f2; }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .error {
            text-align: center;
            padding: 40px;
            color: #f44336;
            background: #ffeaea;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        /* Sortable table styling */
        .sortable {
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-right: 20px;
        }
        
        .sortable:hover {
            background-color: #f5f5f5;
        }
        
        .sort-arrow {
            font-size: 10px;
            color: #999;
            margin-left: 5px;
            opacity: 0.5;
        }
        
        .sortable.asc .sort-arrow::before {
            content: '▲';
            color: #b57614;
            opacity: 1;
        }
        
        .sortable.desc .sort-arrow::before {
            content: '▼';
            color: #b57614;
            opacity: 1;
        }
        
        .sortable.asc .sort-arrow,
        .sortable.desc .sort-arrow {
            opacity: 1;
        }
    </style>
</head>
<body>
    <h1></h1>
    <h1><font color="#b57614">LLDP Network Topology Analysis</font></h1>
    <p><strong>Last Updated:</strong> <span id="last-updated"></span></p>
    
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin: 0;">LLDP Connection Summary</h2>
        <div style="display: flex; gap: 10px;">
            <button id="run-lldp" onclick="runLLDPCheck()" 
                    style="background: #2196f3; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 8px; transition: all 0.3s ease;"
                    onmouseover="this.style.background='#1976d2'" 
                    onmouseout="this.style.background='#2196f3'">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M8,5.14V19.14L19,12.14L8,5.14Z"/>
                </svg>
                <span id="run-lldp-text">Run LLDP Check</span>
            </button>
            <button id="download-csv" onclick="downloadCSV()" 
                    style="background: #4caf50; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 8px; transition: all 0.3s ease;"
                    onmouseover="this.style.background='#45a049'" 
                    onmouseout="this.style.background='#4caf50'">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                </svg>
                Download CSV
            </button>
        </div>
    </div>
    <div class="summary-grid">
        <div class="summary-card card-total">
            <div class="card-value" id="total-connections">0</div>
            <div class="card-label">Total Connections</div>
        </div>
        <div class="summary-card card-excellent">
            <div class="card-value" id="success-connections">0</div>
            <div class="card-label">Successful Links</div>
        </div>
        <div class="summary-card card-critical">
            <div class="card-value" id="failed-connections">0</div>
            <div class="card-label">Failed Links</div>
        </div>
        <div class="summary-card card-warning">
            <div class="card-value" id="warning-connections">0</div>
            <div class="card-label">Warning Links</div>
        </div>
        <div class="summary-card card-info">
            <div class="card-value" id="no-info-connections">0</div>
            <div class="card-label">No Information</div>
        </div>
    </div>
    
    <h2>LLDP Connection Status</h2>
    <div id="filter-info" class="filter-info">
        <span id="filter-text"></span>
        <button onclick="clearFilter()" style="margin-left: 10px; padding: 2px 8px; background: #1976d2; color: white; border: none; border-radius: 3px; cursor: pointer;">Show All</button>
    </div>
    <div id="loading" class="loading">
        <p>Loading LLDP topology data...</p>
    </div>
    <div id="error" class="error" style="display: none;">
        <p>Error loading LLDP data. Please check if the data file exists.</p>
    </div>
    <table class="lldp-table" id="lldp-table" style="display: none;">
        <thead>
        <tr>
            <th class="sortable" data-column="0" data-type="string">
                Local Device <span class="sort-arrow">▲▼</span>
            </th>
            <th class="sortable" data-column="1" data-type="port">
                Local Port <span class="sort-arrow">▲▼</span>
            </th>
            <th class="sortable" data-column="2" data-type="string">
                Expected Neighbor <span class="sort-arrow">▲▼</span>
            </th>
            <th class="sortable" data-column="3" data-type="port">
                Expected Neighbor Port <span class="sort-arrow">▲▼</span>
            </th>
            <th class="sortable" data-column="4" data-type="string">
                Active Neighbor <span class="sort-arrow">▲▼</span>
            </th>
            <th class="sortable" data-column="5" data-type="port">
                Active Neighbor Port <span class="sort-arrow">▲▼</span>
            </th>
            <th class="sortable" data-column="6" data-type="lldp-status">
                Status <span class="sort-arrow">▲▼</span>
            </th>
            <th class="sortable" data-column="7" data-type="string">
                Connection Health <span class="sort-arrow">▲▼</span>
            </th>
        </tr>
        </thead>
        <tbody id="lldp-data">
        </tbody>
    </table>



    <script>
        let totalConnections = 0;
        let successConnections = 0;
        let failedConnections = 0;
        let warningConnections = 0;
        let noInfoConnections = 0;
        
        // Filter state
        let currentFilter = 'ALL';
        let allConnections = [];

        function updateSummaryCards() {
            document.getElementById('total-connections').textContent = totalConnections;
            document.getElementById('success-connections').textContent = successConnections;
            document.getElementById('failed-connections').textContent = failedConnections;
            document.getElementById('warning-connections').textContent = warningConnections;
            document.getElementById('no-info-connections').textContent = noInfoConnections;
        }
        
        function filterConnections(filterType) {
            if (allConnections.length === 0) return;
            
            currentFilter = filterType;
            
            // Clear active state from all cards
            document.querySelectorAll('.summary-card').forEach(card => {
                card.classList.remove('active');
            });
            
            let filteredConnections = allConnections;
            let filterText = '';
            
            if (filterType === 'SUCCESS') {
                filteredConnections = allConnections.filter(conn => determineLLDPStatus(conn).status === 'SUCCESS');
                filterText = `Showing ${filteredConnections.length} Successful Links`;
                document.getElementById('success-connections').parentElement.classList.add('active');
            } else if (filterType === 'FAILED') {
                filteredConnections = allConnections.filter(conn => determineLLDPStatus(conn).status === 'FAILED');
                filterText = `Showing ${filteredConnections.length} Failed Links`;
                document.getElementById('failed-connections').parentElement.classList.add('active');
            } else if (filterType === 'WARNING') {
                filteredConnections = allConnections.filter(conn => determineLLDPStatus(conn).status === 'WARNING');
                filterText = `Showing ${filteredConnections.length} Warning Links`;
                document.getElementById('warning-connections').parentElement.classList.add('active');
            } else if (filterType === 'NO_INFO') {
                filteredConnections = allConnections.filter(conn => determineLLDPStatus(conn).status === 'NO INFO');
                filterText = `Showing ${filteredConnections.length} No Information Links`;
                document.getElementById('no-info-connections').parentElement.classList.add('active');
            } else if (filterType === 'TOTAL') {
                filteredConnections = allConnections;
                filterText = `Showing All ${filteredConnections.length} Connections`;
                document.getElementById('total-connections').parentElement.classList.add('active');
            }
            
            // Show filter info for all filters except TOTAL
            if (filterType !== 'ALL' && filterType !== 'TOTAL') {
                document.getElementById('filter-info').style.display = 'block';
                document.getElementById('filter-text').textContent = filterText;
            } else {
                document.getElementById('filter-info').style.display = 'none';
            }
            
            renderConnectionsTable(filteredConnections);
        }
        
        function clearFilter() {
            currentFilter = 'ALL';
            document.querySelectorAll('.summary-card').forEach(card => {
                card.classList.remove('active');
            });
            document.getElementById('filter-info').style.display = 'none';
            renderConnectionsTable(allConnections);
        }

        function determineLLDPStatus(connection) {
            const { lldpStatus, expectedDevice, expectedPort, actualDevice, actualPort } = connection;
            
            // Based on actual LLDP status from the data
            if (lldpStatus === 'Pass') {
                return {
                    status: 'SUCCESS',
                    healthClass: 'lldp-excellent',
                    statusClass: 'status-success',
                    health: 'LLDP Connection Verified'
                };
            } else if (lldpStatus === 'No-Info') {
                return {
                    status: 'NO INFO',
                    healthClass: 'lldp-unknown',
                    statusClass: 'status-no-info',
                    health: 'No LLDP Response Received'
                };
            } else if (lldpStatus === 'Fail') {
                // Check if it's a port mismatch
                if (actualDevice && expectedDevice && actualDevice === expectedDevice && 
                    actualPort && expectedPort && actualPort !== expectedPort) {
                    return {
                        status: 'WARNING',
                        healthClass: 'lldp-warning',
                        statusClass: 'status-warning',
                        health: `Port Mismatch: Expected ${expectedPort}, Got ${actualPort}`
                    };
                } else {
                    return {
                        status: 'FAILED',
                        healthClass: 'lldp-critical',
                        statusClass: 'status-fail',
                        health: 'Wrong Device/Port Connection'
                    };
                }
            } else {
                // Unknown status - treat as warning
                return {
                    status: 'WARNING',
                    healthClass: 'lldp-warning',
                    statusClass: 'status-warning',
                    health: `Unknown Status: ${lldpStatus}`
                };
            }
        }
        
        function renderConnectionsTable(connections) {
            const tbody = document.getElementById('lldp-data');
            tbody.innerHTML = '';
            
            connections.forEach(connection => {
                const status = determineLLDPStatus(connection);
                const row = tbody.insertRow();
                row.className = status.healthClass;
                
                row.insertCell(0).textContent = connection.localDevice;
                row.insertCell(1).textContent = connection.localPort;
                row.insertCell(2).textContent = connection.expectedDevice || 'N/A';
                row.insertCell(3).textContent = connection.expectedPort || 'N/A';
                row.insertCell(4).textContent = connection.actualDevice || 'N/A';
                row.insertCell(5).textContent = connection.actualPort || 'N/A';
                
                const statusCell = row.insertCell(6);
                statusCell.innerHTML = `<span class="${status.statusClass}">${status.status}</span>`;
                
                row.insertCell(7).textContent = status.health;
            });
        }

        function parseAndDisplayLLDPData(data) {
            const tbody = document.getElementById('lldp-data');
            tbody.innerHTML = '';
            
            const lines = data.split('\n');
            const connections = [];
            let currentDevice = '';
            
            console.log('Total lines to process:', lines.length);
            
            // Parse LLDP data based on actual format
            lines.forEach((line, index) => {
                line = line.trim();
                
                // Extract device name from header lines
                if (line.includes('===') && line.length > 20) {
                    const deviceMatch = line.match(/=+\s*(.+?)\s*=+/);
                    if (deviceMatch) {
                        currentDevice = deviceMatch[1].trim();
                        console.log('Found device:', currentDevice);
                    }
                    return;
                }
                
                // Skip header and separator lines
                if (!line || line.startsWith('Port') || line.startsWith('-') || 
                    line.startsWith('Created') || line.includes('===')) {
                    return;
                }
                
                // Parse port data lines
                const parts = line.split(/\s+/);
                if (parts.length >= 6 && currentDevice) {
                    const localPort = parts[0];
                    const status = parts[1];
                    const expectedDevice = parts[2];
                    const expectedPort = parts[3];
                    const actualDevice = parts[4] === 'None' ? null : parts[4];
                    const actualPort = parts[5] === 'None' ? null : parts[5];
                    
                    connections.push({
                        localDevice: currentDevice,
                        localPort: localPort,
                        expectedDevice: expectedDevice,
                        expectedPort: expectedPort,
                        actualDevice: actualDevice,
                        actualPort: actualPort,
                        lldpStatus: status,
                        originalLine: line
                    });
                } else if (parts.length >= 6) {
                    console.log('Skipping line (no current device):', line);
                } else if (currentDevice && parts.length > 0) {
                    console.log('Skipping line (not enough parts):', line, 'Parts:', parts.length);
                }
            });
            
            console.log('Total connections parsed:', connections.length);

            // Sort connections - problems first
            connections.sort((a, b) => {
                const statusA = determineLLDPStatus(a);
                const statusB = determineLLDPStatus(b);
                
                const priority = { 'FAILED': 0, 'NO INFO': 1, 'WARNING': 2, 'SUCCESS': 3 };
                return priority[statusA.status] - priority[statusB.status];
            });

            // Store all connections for filtering
            allConnections = connections;

            // Count by status
            totalConnections = 0;
            successConnections = 0;
            failedConnections = 0;
            warningConnections = 0;
            noInfoConnections = 0;
            
            connections.forEach(connection => {
                const status = determineLLDPStatus(connection);
                totalConnections++;
                if (status.status === 'SUCCESS') successConnections++;
                else if (status.status === 'FAILED') failedConnections++;
                else if (status.status === 'WARNING') warningConnections++;
                else if (status.status === 'NO INFO') noInfoConnections++;
            });

            updateSummaryCards();
            
            // Setup click events for summary cards
            setupSummaryCardEvents();
            
            // Render table with all connections initially
            renderConnectionsTable(connections);
        }

        function showFallbackContent() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('lldp-table').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            
            // Reset summary cards to 0 when no data available
            totalConnections = 0;
            successConnections = 0;
            failedConnections = 0;
            warningConnections = 0;
            noInfoConnections = 0;
            updateSummaryCards();
            setLastUpdated();
        }
        
        function setLastUpdated(timestampFromFile) {
            let dateToUse;
            
            if (timestampFromFile) {
                // Parse "2025-08-05 04-22" format from lldp_results.ini
                const parts = timestampFromFile.trim().split(' ');
                if (parts.length === 2) {
                    const datePart = parts[0]; // "2025-08-05"
                    const timePart = parts[1].replace('-', ':'); // "04-22" -> "04:22"
                    dateToUse = new Date(datePart + 'T' + timePart + ':00');
                } else {
                    // Fallback if format doesn't match
                    dateToUse = new Date();
                }
            } else {
                // Fallback to current time if no timestamp available
                dateToUse = new Date();
            }
            
                    const options = { 
            year: 'numeric', 
            month: '2-digit', 
            day: '2-digit', 
            hour: '2-digit', 
            minute: '2-digit',
            second: '2-digit',
            hour12: false
        };
            const formattedDate = dateToUse.toLocaleString('en-US', options);
            document.getElementById('last-updated').textContent = formattedDate;
        }
        
        function setupSummaryCardEvents() {
            // Total connections card
            document.getElementById('total-connections').parentElement.addEventListener('click', function() {
                if (totalConnections > 0) filterConnections('TOTAL');
            });
            
            // Success connections card
            document.getElementById('success-connections').parentElement.addEventListener('click', function() {
                if (successConnections > 0) filterConnections('SUCCESS');
            });
            
            // Failed connections card
            document.getElementById('failed-connections').parentElement.addEventListener('click', function() {
                if (failedConnections > 0) filterConnections('FAILED');
            });
            
            // Warning connections card
            document.getElementById('warning-connections').parentElement.addEventListener('click', function() {
                if (warningConnections > 0) filterConnections('WARNING');
            });
            
            // No info connections card
            document.getElementById('no-info-connections').parentElement.addEventListener('click', function() {
                if (noInfoConnections > 0) filterConnections('NO_INFO');
            });
        }

        function loadLLDPData() {
            fetch('lldp_results.ini')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Data file not found. Status: ${response.status}`);
                    }
                    return response.text();
                })
                .then(data => {
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('lldp-table').style.display = 'table';
                    
                    // Extract timestamp from data (first line: "Created on YYYY-MM-DD HH-MM")
                    const firstLine = data.split('\n')[0];
                    if (firstLine.startsWith('Created on ')) {
                        const timestampStr = firstLine.replace('Created on ', '');
                        setLastUpdated(timestampStr);
                    } else {
                        setLastUpdated();
                    }
                    
                    parseAndDisplayLLDPData(data);
                })
                .catch(error => {
                    showFallbackContent();
                });
        }

        // Generic table sorting functionality
        let currentSort = { column: -1, direction: 'asc' };
        
        function initTableSorting() {
            const headers = document.querySelectorAll('.sortable');
            headers.forEach(header => {
                header.addEventListener('click', function() {
                    const column = parseInt(this.dataset.column);
                    const type = this.dataset.type;
                    
                    // Toggle sort direction
                    if (currentSort.column === column) {
                        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        currentSort.direction = 'asc';
                    }
                    currentSort.column = column;
                    
                    // Update header styling
                    headers.forEach(h => h.classList.remove('asc', 'desc'));
                    this.classList.add(currentSort.direction);
                    
                    // Sort table
                    sortLLDPTable(column, currentSort.direction, type);
                });
            });
        }
        
        function sortLLDPTable(columnIndex, direction, type) {
            const table = document.getElementById('lldp-table');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.rows);
            
            rows.sort((a, b) => {
                let aVal = a.cells[columnIndex].textContent.trim();
                let bVal = b.cells[columnIndex].textContent.trim();
                
                // Extract actual text for status column (remove HTML)
                if (type === 'lldp-status') {
                    aVal = a.cells[columnIndex].querySelector('span')?.textContent || aVal;
                    bVal = b.cells[columnIndex].querySelector('span')?.textContent || bVal;
                }
                
                let result = 0;
                
                switch(type) {
                    case 'port':
                        result = comparePort(aVal, bVal);
                        break;
                    case 'lldp-status':
                        result = compareLLDPStatus(aVal, bVal);
                        break;
                    case 'string':
                    default:
                        result = aVal.localeCompare(bVal, undefined, { numeric: true, sensitivity: 'base' });
                        break;
                }
                
                return direction === 'desc' ? -result : result;
            });
            
            // Clear tbody and add sorted rows back
            tbody.innerHTML = '';
            rows.forEach(row => tbody.appendChild(row));
        }
        
        function comparePort(a, b) {
            if (a === 'N/A') return 1;
            if (b === 'N/A') return -1;
            
            // Handle port sorting (swp1, swp10, swp1s0, etc.)
            const extractPortNumber = (port) => {
                const match = port.match(/swp(\d+)(?:s(\d+))?/);
                if (match) {
                    const mainPort = parseInt(match[1]);
                    const subPort = match[2] ? parseInt(match[2]) : 0;
                    return mainPort * 1000 + subPort; // swp1 = 1000, swp1s0 = 1000, swp1s1 = 1001
                }
                return port.localeCompare(b, undefined, { numeric: true });
            };
            
            return extractPortNumber(a) - extractPortNumber(b);
        }
        
        function compareLLDPStatus(a, b) {
            const priority = {
                'FAILED': 0,
                'WARNING': 1,
                'NO INFO': 2,
                'SUCCESS': 3
            };
            
            return (priority[a] || 4) - (priority[b] || 4);
        }

        // Run LLDP Check Function
        function runLLDPCheck() {
            const button = document.getElementById('run-lldp');
            const buttonText = document.getElementById('run-lldp-text');
            const originalText = buttonText.textContent;
            
            // Disable button and show loading
            button.disabled = true;
            button.style.opacity = '0.7';
            button.style.cursor = 'not-allowed';
            buttonText.textContent = 'Running...';
            
            // Make request to trigger LLDP check via simple endpoint
            fetch('/trigger-lldp', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                console.log('✅ LLDP check response:', data);
                
                // Always show manual trigger instruction
                buttonText.textContent = '✓ Triggered';
                button.style.background = '#4caf50';
                
                // Show instruction notification
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #2196f3;
                    color: white;
                    padding: 15px 20px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                    z-index: 1000;
                    font-size: 14px;
                    max-width: 350px;
                    font-family: monospace;
                `;
                notification.innerHTML = `
                    <strong>✅ LLDP Check Requested</strong><br>
                    The topology analysis will be updated automatically in the next few minutes.<br>
                    <small>You can refresh this page after 1 minute to see the latest results.</small>
                `;
                
                document.body.appendChild(notification);
                
                // Auto-remove notification after 10 seconds
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 10000);
                
                // Reset button after 3 seconds
                setTimeout(() => {
                    button.disabled = false;
                    button.style.opacity = '1';
                    button.style.cursor = 'pointer';
                    button.style.background = '#2196f3';
                    buttonText.textContent = originalText;
                }, 3000);
            })
            .catch(error => {
                console.error('❌ Error running LLDP check:', error);
                
                // Show error state
                buttonText.textContent = '✗ Error';
                button.style.background = '#f44336';
                
                // Show error notification
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #f44336;
                    color: white;
                    padding: 15px 20px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                    z-index: 1000;
                    font-size: 14px;
                    max-width: 300px;
                `;
                notification.innerHTML = `
                    <strong>Error!</strong><br>
                    Could not start LLDP check. Please try again or contact administrator.
                `;
                
                document.body.appendChild(notification);
                
                // Auto-remove notification after 5 seconds
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 5000);
                
                // Reset button after 3 seconds
                setTimeout(() => {
                    button.disabled = false;
                    button.style.opacity = '1';
                    button.style.cursor = 'pointer';
                    button.style.background = '#2196f3';
                    buttonText.textContent = originalText;
                }, 3000);
            });
        }

        // CSV Download Function
        function downloadCSV() {
            try {
                // Get current date for filename
                const now = new Date();
                const dateStr = now.toISOString().slice(0, 10); // YYYY-MM-DD
                const timeStr = now.toTimeString().slice(0, 5).replace(':', '-'); // HH-MM
                const filename = `LLDP_Topology_Report_${dateStr}_${timeStr}.csv`;
                
                // Create CSV header
                const headers = [
                    'Local Device',
                    'Local Port', 
                    'Expected Neighbor',
                    'Expected Port',
                    'Active Neighbor',
                    'Active Port',
                    'Status',
                    'Connection Health'
                ];
                
                let csvContent = headers.join(',') + '\n';
                
                // Get table data (only visible rows)
                const table = document.getElementById('lldp-table');
                const tbody = table.querySelector('tbody');
                const rows = tbody.querySelectorAll('tr');
                
                // Add summary stats as comments
                csvContent += `# LLDP Connection Summary Report\n`;
                csvContent += `# Generated: ${now.toLocaleString()}\n`;
                csvContent += `# Total Connections: ${document.getElementById('total-connections').textContent}\n`;
                csvContent += `# Successful Links: ${document.getElementById('success-connections').textContent}\n`;
                csvContent += `# Failed Links: ${document.getElementById('failed-connections').textContent}\n`;
                csvContent += `# Warning Links: ${document.getElementById('warning-connections').textContent}\n`;
                csvContent += `# No Information: ${document.getElementById('no-info-connections').textContent}\n`;
                csvContent += `#\n`;
                
                // Process each visible row
                rows.forEach(row => {
                    if (row.style.display !== 'none') {
                        const cells = row.querySelectorAll('td');
                        if (cells.length >= 7) {
                            const rowData = [
                                cells[0].textContent.trim(), // Device
                                cells[1].textContent.trim(), // Local Port
                                cells[2].textContent.trim(), // Expected Neighbor
                                cells[3].textContent.trim(), // Expected Port
                                cells[4].textContent.trim(), // Active Neighbor
                                cells[5].textContent.trim(), // Active Port
                                cells[6].textContent.trim(), // Status
                                cells[7].textContent.trim()  // Health
                            ];
                            
                            // Escape commas and quotes in data
                            const escapedData = rowData.map(field => {
                                if (field.includes(',') || field.includes('"') || field.includes('\n')) {
                                    return '"' + field.replace(/"/g, '""') + '"';
                                }
                                return field;
                            });
                            
                            csvContent += escapedData.join(',') + '\n';
                        }
                    }
                });
                
                // Create and trigger download
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                console.log(`✅ CSV downloaded: ${filename}`);
                
            } catch (error) {
                console.error('❌ Error generating CSV:', error);
                alert('Error generating CSV file. Please try again.');
            }
        }

        // Load data when page loads
        window.addEventListener('load', function() {
            loadLLDPData();
            initTableSorting();
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
    <h1></h1>
    <title>Link Flap Detection Results</title>
    <link rel="stylesheet" type="text/css" href="/css/styles2.css">
    <style>
        .flap-excellent { color: #4caf50; font-weight: bold; }
        .flap-good { color: #8bc34a; font-weight: bold; }
        .flap-warning { color: #ff9800; font-weight: bold; }
        .flap-critical { color: #f44336; font-weight: bold; }
        .flap-unknown { color: gray; }
        .flap-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        .flap-table th, .flap-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .flap-table th { background-color: #f2f2f2; }
        .summary-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 15px; 
            margin: 20px 0; 
        }
        .summary-card { 
            background: #f8f9fa; 
            padding: 15px; 
            border-radius: 8px; 
            border-left: 4px solid #007bff; 
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .summary-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .summary-card.active {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.25);
            border-left-width: 6px;
        }
        .metric { font-size: 24px; font-weight: bold; }
        
        .filter-info {
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            background: #e8f4fd;
            border-radius: 4px;
            color: #1976d2;
            display: none;
        }
        .status-established { color: #4caf50; font-weight: bold; }
        .status-flapping { color: #f44336; font-weight: bold; }
        .status-flapped { color: #ff9800; font-weight: bold; }
        .status-ok { color: #4caf50; font-weight: bold; }
        .transition-good { color: #4caf50; }
        .transition-warning { color: #ff9800; }
        .transition-critical { color: #f44336; }
        
        /* Sortable table styling */
        .sortable { cursor: pointer; user-select: none; position: relative; padding-right: 20px; }
        .sortable:hover { background-color: #f5f5f5; }
        .sort-arrow { font-size: 10px; color: #999; margin-left: 5px; opacity: 0.5; }
        .sortable.asc .sort-arrow::before { content: '▲'; color: #b57614; opacity: 1; }
        .sortable.desc .sort-arrow::before { content: '▼'; color: #b57614; opacity: 1; }
        .sortable.asc .sort-arrow, .sortable.desc .sort-arrow { opacity: 1; }
    </style>
</head>
<body>
    <h1><font color="#b57614">Link Flap Detection Results</font></h1>
    <p><strong>Last Updated:</strong> 2025-08-06 00:06:04</p>
    
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin: 0;">Network Summary</h2>
        <button id="download-csv" onclick="downloadCSV()" 
                style="background: #4caf50; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 8px; transition: all 0.3s ease;"
                onmouseover="this.style.background='#45a049'" 
                onmouseout="this.style.background='#4caf50'">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
            </svg>
            Download CSV
        </button>
    </div>
    <div class="summary-grid">
        <div class="summary-card" id="total-devices-card">
            <div class="metric" id="total-devices">0</div>
            <div>Total Devices</div>
        </div>
        <div class="summary-card" id="total-ports-card">
            <div class="metric" id="total-ports">0</div>
            <div>Total Ports</div>
        </div>
        <div class="summary-card" id="stable-card">
            <div class="metric flap-excellent" id="stable-ports">0</div>
            <div>Stable</div>
        </div>
        <div class="summary-card" id="problematic-card">
            <div class="metric flap-critical" id="problematic-ports">0</div>
            <div>Problematic</div>
        </div>
        <div class="summary-card" id="stability-card">
            <div class="metric" id="stability-ratio">0.0%</div>
            <div>Stability Ratio</div>
        </div>
    </div>
    
    <div id="filter-info" class="filter-info">
        <span id="filter-text"></span>
        <button onclick="clearFilter()" style="margin-left: 10px; padding: 2px 8px; background: #1976d2; color: white; border: none; border-radius: 3px; cursor: pointer;">Show All</button>
    </div>

    <h2>Interface Flapping Status (0 total)</h2>
    <table class="flap-table" id="flap-table">
        <thead>
        <tr>
            <th class="sortable" data-column="0" data-type="string">Device <span class="sort-arrow">▲▼</span></th>
            <th class="sortable" data-column="1" data-type="port">Interface <span class="sort-arrow">▲▼</span></th>
            <th class="sortable" data-column="2" data-type="flap-status">Status <span class="sort-arrow">▲▼</span></th>
            <th class="sortable" data-column="3" data-type="number">30s Flaps <span class="sort-arrow">▲▼</span></th>
            <th class="sortable" data-column="4" data-type="number">1m Flaps <span class="sort-arrow">▲▼</span></th>
            <th class="sortable" data-column="5" data-type="number">5m Flaps <span class="sort-arrow">▲▼</span></th>
            <th class="sortable" data-column="6" data-type="number">1h Flaps <span class="sort-arrow">▲▼</span></th>
            <th class="sortable" data-column="7" data-type="number">12h Flaps <span class="sort-arrow">▲▼</span></th>
            <th class="sortable" data-column="8" data-type="number">24h Flaps <span class="sort-arrow">▲▼</span></th>
            <th class="sortable" data-column="9" data-type="number">Total Transitions <span class="sort-arrow">▲▼</span></th>
        </tr>
        </thead>
        <tbody id="flap-data">

    </table>
    
    <h2>Link Flap Detection Thresholds</h2>
    <table class="flap-table">
        <tr><th>Parameter</th><th>Threshold</th><th>Description</th></tr>
        <tr><td>Detection Window</td><td>125 seconds</td><td>Time window for carrier transition analysis</td></tr>
        <tr><td>Min Transition Delta</td><td>2+ transitions</td><td>Minimum transitions to trigger flap detection</td></tr>
        <tr><td>Flap Persistence</td><td>60 seconds</td><td>Duration flap status remains active</td></tr>
        <tr><td>High Transition Alert</td><td>50+ transitions</td><td>Indicates potential hardware issues</td></tr>
        <tr><td>Data Retention</td><td>24 hours</td><td>Historical carrier transition data retention</td></tr>
    </table>

    <script>
        // Filter functionality
        let currentFilter = 'ALL';
        let allRows = [];
        
        document.addEventListener('DOMContentLoaded', function() {
            // Store all table rows for filtering
            allRows = Array.from(document.querySelectorAll('#flap-data tr'));
            
            // Add click events to summary cards
            setupCardEvents();
            
            // Initialize table sorting
            initTableSorting();
        });
        
        function setupCardEvents() {
            // Check if elements exist
            const totalDevicesCard = document.getElementById('total-devices-card');
            const totalPortsCard = document.getElementById('total-ports-card');
            
            if (totalDevicesCard) {
                totalDevicesCard.addEventListener('click', function() {
                    filterPorts('TOTAL');
                });
            }
            
            if (totalPortsCard) {
                totalPortsCard.addEventListener('click', function() {
                    if (parseInt(document.getElementById('total-ports').textContent) > 0) {
                        filterPorts('TOTAL');
                    }
                });
            }
            
            document.getElementById('stable-card').addEventListener('click', function() {
                if (parseInt(document.getElementById('stable-ports').textContent) > 0) {
                    filterPorts('STABLE');
                }
            });
            
            document.getElementById('problematic-card').addEventListener('click', function() {
                if (parseInt(document.getElementById('problematic-ports').textContent) > 0) {
                    filterPorts('PROBLEMATIC');
                }
            });
            
            document.getElementById('stability-card').addEventListener('click', function() {
                console.log('LINK FLAP: Stability clicked');
                filterPorts('TOTAL'); // Stability ratio shows all ports
            });
        }
        
        function filterPorts(filterType) {
            currentFilter = filterType;
            
            // Clear active state from all cards
            document.querySelectorAll('.summary-card').forEach(card => {
                card.classList.remove('active');
            });
            
            let filteredRows = allRows;
            let filterText = '';
            
            if (filterType === 'STABLE') {
                filteredRows = allRows.filter(row => row.dataset.status === 'ok');
                filterText = 'Showing ' + filteredRows.length + ' Stable Ports';
                document.getElementById('stable-card').classList.add('active');
            } else if (filterType === 'PROBLEMATIC') {
                filteredRows = allRows.filter(row => 
                    row.dataset.status === 'flapping' || 
                    row.dataset.status === 'flapped'
                );
                filterText = 'Showing ' + filteredRows.length + ' Problematic Ports';
                document.getElementById('problematic-card').classList.add('active');
            } else if (filterType === 'TOTAL') {
                filteredRows = allRows;
                document.getElementById('total-ports-card').classList.add('active');
            }
            
            // Show filter info for all filters except TOTAL
            if (filterType !== 'ALL' && filterType !== 'TOTAL') {
                document.getElementById('filter-info').style.display = 'block';
                document.getElementById('filter-text').textContent = filterText;
            } else {
                document.getElementById('filter-info').style.display = 'none';
            }
            
            // Hide all rows first
            allRows.forEach(row => row.style.display = 'none');
            
            // Show filtered rows
            filteredRows.forEach(row => row.style.display = '');
        }
        
        function clearFilter() {
            currentFilter = 'ALL';
            document.querySelectorAll('.summary-card').forEach(card => {
                card.classList.remove('active');
            });
            document.getElementById('filter-info').style.display = 'none';
            
            // Show all rows
            allRows.forEach(row => row.style.display = '');
        }
        
        // Generic table sorting functionality
        let tableSortState = { column: -1, direction: 'asc' };
        
        function initTableSorting() {
            const headers = document.querySelectorAll('.sortable');
            headers.forEach(header => {
                header.addEventListener('click', function() {
                    const column = parseInt(this.dataset.column);
                    const type = this.dataset.type;
                    
                    // Toggle sort direction
                    if (tableSortState.column === column) {
                        tableSortState.direction = tableSortState.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        tableSortState.direction = 'asc';
                    }
                    tableSortState.column = column;
                    
                    // Update header styling
                    headers.forEach(h => h.classList.remove('asc', 'desc'));
                    this.classList.add(tableSortState.direction);
                    
                    // Sort table
                    sortFlapTable(column, tableSortState.direction, type);
                });
            });
        }
        
        function sortFlapTable(columnIndex, direction, type) {
            const table = document.getElementById('flap-table');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.rows);
            
            rows.sort((a, b) => {
                let aVal = a.cells[columnIndex].textContent.trim();
                let bVal = b.cells[columnIndex].textContent.trim();
                
                // Extract actual text for status columns (remove HTML)
                if (type === 'flap-status') {
                    aVal = a.cells[columnIndex].querySelector('span')?.textContent || aVal;
                    bVal = b.cells[columnIndex].querySelector('span')?.textContent || bVal;
                }
                
                let result = 0;
                
                switch(type) {
                    case 'number':
                        result = parseInt(aVal) - parseInt(bVal);
                        break;
                    case 'port':
                        result = comparePort(aVal, bVal);
                        break;
                    case 'flap-status':
                        result = compareFlapStatus(aVal, bVal);
                        break;
                    case 'string':
                    default:
                        result = aVal.localeCompare(bVal, undefined, { numeric: true, sensitivity: 'base' });
                        break;
                }
                
                return direction === 'desc' ? -result : result;
            });
            
            // Clear tbody and add sorted rows back
            tbody.innerHTML = '';
            rows.forEach(row => tbody.appendChild(row));
        }
        
        function comparePort(a, b) {
            if (a === 'N/A') return 1;
            if (b === 'N/A') return -1;
            
            // Handle port sorting (swp1, swp10, swp1s0, etc.)
            const extractPortNumber = (port) => {
                const match = port.match(/swp(\d+)(?:s(\d+))?/);
                if (match) {
                    const mainPort = parseInt(match[1]);
                    const subPort = match[2] ? parseInt(match[2]) : 0;
                    return mainPort * 1000 + subPort;
                }
                return port.localeCompare(b, undefined, { numeric: true });
            };
            
            return extractPortNumber(a) - extractPortNumber(b);
        }
        
        function compareFlapStatus(a, b) {
            const priority = {
                'FLAPPING': 0,
                'FLAPPED': 1,
                'OK': 2
            };
            
            return (priority[a] || 3) - (priority[b] || 3);
        }

        // CSV Download Function
        function downloadCSV() {
            try {
                // Get current date for filename
                const now = new Date();
                const dateStr = now.toISOString().slice(0, 10); // YYYY-MM-DD
                const timeStr = now.toTimeString().slice(0, 5).replace(':', '-'); // HH-MM
                const filename = `Link_Flap_Analysis_Report_${dateStr}_${timeStr}.csv`;
                
                // Create CSV header
                const headers = [
                    'Device',
                    'Port',
                    'Current Status',
                    'Last 30 Seconds',
                    'Last 5 Minutes', 
                    'Last 24 Hours',
                    'Total Transitions'
                ];
                
                let csvContent = headers.join(',') + '\n';
                
                // Get table data (only visible rows)
                const table = document.getElementById('flap-table');
                const tbody = table.querySelector('tbody');
                const rows = tbody.querySelectorAll('tr');
                
                // Add summary stats as comments
                csvContent += `# Link Flap Analysis Summary Report\n`;
                csvContent += `# Generated: ${now.toLocaleString()}\n`;
                csvContent += `# Total Devices: ${document.getElementById('total-devices').textContent}\n`;
                csvContent += `# Total Ports: ${document.getElementById('total-ports').textContent}\n`;
                csvContent += `# Stable Ports: ${document.getElementById('stable-ports').textContent}\n`;
                csvContent += `# Problematic Ports: ${document.getElementById('problematic-ports').textContent}\n`;
                csvContent += `# Stability Ratio: ${document.getElementById('stability-ratio').textContent}\n`;
                csvContent += `#\n`;
                
                // Process each visible row
                rows.forEach(row => {
                    if (row.style.display !== 'none') {
                        const cells = row.querySelectorAll('td');
                        if (cells.length >= 7) {
                            const rowData = [
                                cells[0].textContent.trim(), // Device
                                cells[1].textContent.trim(), // Port
                                cells[2].querySelector('span') ? cells[2].querySelector('span').textContent.trim() : cells[2].textContent.trim(), // Status
                                cells[3].textContent.trim(), // 30 sec
                                cells[4].textContent.trim(), // 5 min
                                cells[5].textContent.trim(), // 24 hrs
                                cells[6].textContent.trim()  // Total
                            ];
                            
                            // Escape commas and quotes in data
                            const escapedData = rowData.map(field => {
                                if (field.includes(',') || field.includes('"') || field.includes('\n')) {
                                    return '"' + field.replace(/"/g, '""') + '"';
                                }
                                return field;
                            });
                            
                            csvContent += escapedData.join(',') + '\n';
                        }
                    }
                });
                
                // Create and trigger download
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                console.log(`✅ CSV downloaded: ${filename}`);
                
            } catch (error) {
                console.error('❌ Error generating CSV:', error);
                alert('Error generating CSV file. Please try again.');
            }
        }
    </script>
</body>
</html>
server {
        listen 80 default_server;
        listen [::]:80 default_server;

        root /var/www/html;

        index index.html index.htm;

        server_name _;

        location / {
            # Optional: Uncomment lines below to enable authentication
            # auth_basic "LLDPq Network Monitoring";
            # auth_basic_user_file /etc/nginx/.htpasswd;
            
            try_files $uri $uri/ =404;
            add_header Cache-Control "no-store, no-cache, must-revalidate, max-age=0";
            add_header Pragma "no-cache";
            add_header Expires "Thu, 01 Jan 1970 00:00:00 GMT";
        }
        location /configs/ {
            autoindex on;
            autoindex_exact_size off;
            autoindex_localtime on;
        }
        location /hstr/ {
            autoindex on;
            autoindex_exact_size off;
            autoindex_localtime on;
        }
        location /monitor-results/ {
            autoindex on;
            autoindex_exact_size off;
            autoindex_localtime on;
        }
        
        # Auto-trigger endpoint with file creation
        location = /trigger-lldp {
            add_header Content-Type application/json always;
            add_header Access-Control-Allow-Origin * always;
            add_header Access-Control-Allow-Methods "POST, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Content-Type" always;
            
            # Handle CORS preflight
            if ($request_method = OPTIONS) {
                return 200 '{"status": "ok", "message": "CORS preflight"}';
            }
            
            # Create trigger file and return success
            access_by_lua_block {
                local trigger_file = "/var/www/html/.web_trigger"
                local file = io.open(trigger_file, "w")
                if file then
                    file:write(tostring(os.time()))
                    file:close()
                end
            }
            
            return 200 '{"status": "started", "message": "LLDP check triggered automatically", "note": "Analysis will complete within 1-2 minutes."}';
        }
}
